#include <stdio.h>
#include <string.h>
#include <windows.h>
#include <stdlib.h>

// ---------------- CONSTANTES ----------------
#define MAX_PRODUCTOS 20
#define MAX_CLIENTES 50

// ---------------- ESTRUCTURAS ----------------
typedef struct {
    char nombre[30];
    int cantidad;
    float costo;
} Producto;

typedef struct {
    char nombre[30];
    char cedula[15];
    char producto[30];
    int cantidad;
} Cliente;

// ---------------- VARIABLES GLOBALES ----------------
Producto inventario[MAX_PRODUCTOS];
Cliente clientes[MAX_CLIENTES];

int totalProductos = 0;
int totalClientes = 0;

// ---------------- FUNCIONES ----------------
void menuPrincipal();
void agregarProducto();
void mostrarInventario();
void registrarCompra();
void mostrarClientes();
void resumenSemanal();

void guardarDatos();
void cargarDatos();

void limpiarBuffer();
int leerEntero();
float leerFloat();

// ---------------- MAIN ----------------
int main() {
    int opcion;

    cargarDatos();

    do {
        system("cls");

        menuPrincipal();
        printf("Seleccione una opcion: ");
        opcion = leerEntero();

        if (opcion < 1 || opcion > 6) {
            printf("\nOpcion fuera de rango.\n");
            system("pause");
            continue;
        }

        switch(opcion) {
            case 1:
                agregarProducto();
                guardarDatos();
                break;
            case 2:
                mostrarInventario();
                break;
            case 3:
                registrarCompra();
                guardarDatos();
                break;
            case 4:
                mostrarClientes();
                break;
            case 5:
                resumenSemanal();
                break;
            case 6:
                guardarDatos();
                printf("\nSaliendo del programa...\n");
                break;
        }

        system("pause");

    } while(opcion != 6);

    return 0;
}

// ---------------- UTILIDADES ----------------
void limpiarBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

int leerEntero() {
    int x;
    while (scanf("%d", &x) != 1) {
        printf("Entrada invalida. Ingrese un numero: ");
        limpiarBuffer();
    }
    limpiarBuffer();
    return x;
}

float leerFloat() {
    float x;
    while (scanf("%f", &x) != 1) {
        printf("Entrada invalida. Ingrese un numero: ");
        limpiarBuffer();
    }
    limpiarBuffer();
    return x;
}

// ---------------- MENU ----------------
void menuPrincipal() {
    printf("\n===== CONTROL DE INVENTARIO - DISTRIBUIDORA DE HUEVOS =====\n");
    printf("\n===== EGG-CONTROL =====\n");
    printf("\n===== GRUPO 1 =====\n");
    printf("1. Agregar productos al inventario\n");
    printf("2. Ver inventario\n");
    printf("3. Registrar compra\n");
    printf("4. Clientes registrados\n");
    printf("5. Resumen semanal de ventas\n");
    printf("6. Salir\n");
}

// ---------------- AGREGAR PRODUCTO ----------------
void agregarProducto() {
    if (totalProductos >= MAX_PRODUCTOS) {
        printf("\nInventario lleno.\n");
        return;
    }

    char nombreTemp[30];
    int i;

    printf("\n--- AGREGAR PRODUCTO ---\n");

    do {
        printf("Nombre del producto: ");
        scanf(" %[^\n]", nombreTemp);

        if (strlen(nombreTemp) == 0) {
            printf("El nombre no puede estar vacio.\n");
            continue;
        }

        // Verificar duplicado
        for (i = 0; i < totalProductos; i++) {
            if (strcmp(inventario[i].nombre, nombreTemp) == 0) {
                printf("Ese producto ya existe.\n");
                return;
            }
        }

        break;
    } while (1);

    int cantidad;
    do {
        printf("Cantidad a ingresar: ");
        cantidad = leerEntero();
        if (cantidad <= 0)
            printf("La cantidad debe ser mayor que cero.\n");
    } while (cantidad <= 0);

    float costo;
    do {
        printf("Costo unitario: ");
        costo = leerFloat();
        if (costo <= 0)
            printf("El costo debe ser mayor que cero.\n");
    } while (costo <= 0);

    strcpy(inventario[totalProductos].nombre, nombreTemp);
    inventario[totalProductos].cantidad = cantidad;
    inventario[totalProductos].costo = costo;

    totalProductos++;

    printf("\nProducto agregado correctamente.\n");
}

// ---------------- MOSTRAR INVENTARIO ----------------
void mostrarInventario() {
    int i;

    if (totalProductos == 0) {
        printf("\nNo hay productos registrados.\n");
        return;
    }

    printf("\n------------------ INVENTARIO ------------------\n");
    printf("%-5s %-20s %-10s %-10s\n", "No", "Producto", "Cantidad", "Costo");
    printf("------------------------------------------------\n");

    for (i = 0; i < totalProductos; i++) {
        printf("%-5d %-20s %-10d $%-9.2f\n",
               i + 1,
               inventario[i].nombre,
               inventario[i].cantidad,
               inventario[i].costo);
    }
}

// ---------------- REGISTRAR COMPRA ----------------
void registrarCompra() {
    int i, cantidadCompra, encontrado = -1;
    char productoCompra[30];

    if (totalClientes >= MAX_CLIENTES) {
        printf("\nLimite de clientes alcanzado.\n");
        return;
    }

    if (totalProductos == 0) {
        printf("\nNo hay productos en inventario.\n");
        return;
    }

    printf("\n--- REGISTRAR COMPRA ---\n");

    printf("Nombre del cliente: ");
    scanf(" %[^\n]", clientes[totalClientes].nombre);

    printf("Cedula del cliente: ");
    scanf(" %[^\n]", clientes[totalClientes].cedula);

    printf("Producto a comprar: ");
    scanf(" %[^\n]", productoCompra);

    for (i = 0; i < totalProductos; i++) {
        if (strcmp(inventario[i].nombre, productoCompra) == 0) {
            encontrado = i;
            break;
        }
    }

    if (encontrado == -1) {
        printf("\nProducto no encontrado.\n");
        return;
    }

    do {
        printf("Cantidad a comprar: ");
        cantidadCompra = leerEntero();
        if (cantidadCompra <= 0)
            printf("La cantidad debe ser mayor que cero.\n");
    } while (cantidadCompra <= 0);

    if (cantidadCompra > inventario[encontrado].cantidad) {
        printf("\nStock insuficiente.\n");
        return;
    }

    inventario[encontrado].cantidad -= cantidadCompra;

    strcpy(clientes[totalClientes].producto, productoCompra);
    clientes[totalClientes].cantidad = cantidadCompra;

    totalClientes++;

    printf("\nCompra registrada exitosamente.\n");
}

// ---------------- MOSTRAR CLIENTES ----------------
void mostrarClientes() {
    char cedulaBuscada[15];
    int i;
    int encontrado = 0;

    if (totalClientes == 0) {
        printf("\nNo hay clientes registrados.\n");
        return;
    }

    printf("\n--- BUSCAR CLIENTE POR CEDULA ---\n");
    printf("Ingrese la cedula del cliente: ");
    scanf(" %[^\n]", cedulaBuscada);

    for (i = 0; i < totalClientes; i++) {
        if (strcmp(clientes[i].cedula, cedulaBuscada) == 0) {
            printf("\n---------------- CLIENTE ENCONTRADO ----------------\n");
            printf("%-20s %-15s %-15s %-10s\n",
                   "Nombre", "Cedula", "Producto", "Cantidad");
            printf("----------------------------------------------------\n");

            printf("%-20s %-15s %-15s %-10d\n",
                   clientes[i].nombre,
                   clientes[i].cedula,
                   clientes[i].producto,
                   clientes[i].cantidad);

            encontrado = 1;
            break;
        }
    }

    if (!encontrado) {
        printf("\nCliente no registrado.\n");
    }
}

// ---------------- RESUMEN SEMANAL ----------------
void resumenSemanal() {
    int i, j;
    float totalGanancias = 0;
    int totalUnidades = 0;
    float precioUnitario = 0;

    if (totalClientes == 0) {
        printf("\nNo se han registrado ventas.\n");
        return;
    }

    printf("\n===================== RESUMEN SEMANAL DE VENTAS =====================\n");
    printf("%-5s %-20s %-20s %-10s %-12s %-12s\n",
           "No", "Producto", "Cliente", "Cantidad", "Precio", "Total");
    printf("---------------------------------------------------------------------\n");

    for (i = 0; i < totalClientes; i++) {

        precioUnitario = 0;
        for (j = 0; j < totalProductos; j++) {
            if (strcmp(inventario[j].nombre, clientes[i].producto) == 0) {
                precioUnitario = inventario[j].costo;
                break;
            }
        }

        float totalVenta = clientes[i].cantidad * precioUnitario;

        printf("%-5d %-20s %-20s %-10d $%-11.2f $%-11.2f\n",
               i + 1,
               clientes[i].producto,
               clientes[i].nombre,
               clientes[i].cantidad,
               precioUnitario,
               totalVenta);

        totalGanancias += totalVenta;
        totalUnidades += clientes[i].cantidad;
    }

    printf("---------------------------------------------------------------------\n");
    printf("Total de unidades vendidas: %d\n", totalUnidades);
    printf("GANANCIA TOTAL: $ %.2f\n", totalGanancias);
}

// ---------------- GUARDAR DATOS ----------------
void guardarDatos() {
    FILE *f;

    f = fopen("inventario.dat", "wb");
    if (f != NULL) {
        fwrite(&totalProductos, sizeof(int), 1, f);
        fwrite(inventario, sizeof(Producto), totalProductos, f);
        fclose(f);
    }

    f = fopen("clientes.dat", "wb");
    if (f != NULL) {
        fwrite(&totalClientes, sizeof(int), 1, f);
        fwrite(clientes, sizeof(Cliente), totalClientes, f);
        fclose(f);
    }
}

// ---------------- CARGAR DATOS ----------------
void cargarDatos() {
    FILE *f;

    f = fopen("inventario.dat", "rb");
    if (f != NULL) {
        fread(&totalProductos, sizeof(int), 1, f);
        fread(inventario, sizeof(Producto), totalProductos, f);
        fclose(f);
    }

    f = fopen("clientes.dat", "rb");
    if (f != NULL) {
        fread(&totalClientes, sizeof(int), 1, f);
        fread(clientes, sizeof(Cliente), totalClientes, f);
        fclose(f);
    }
}